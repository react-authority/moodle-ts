name: Code Generation

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: "0 2 * * 0"
  workflow_dispatch:
    inputs:
      moodle_refs:
        description: "Comma-separated Moodle refs to process (e.g., MOODLE_405_STABLE,MOODLE_500_STABLE)"
        required: false
        default: "MOODLE_405_STABLE,MOODLE_500_STABLE"

permissions:
  contents: write
  pull-requests: write

jobs:
  extract-schema:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        moodle_ref:
          - MOODLE_405_STABLE
          - MOODLE_500_STABLE
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: moodle
          POSTGRES_PASSWORD: moodle
          POSTGRES_DB: moodle
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout moodle-ts
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: pgsql, zip, gd, intl, soap, opcache, xmlrpc
          coverage: none
          ini-values: max_input_vars=5000

      - name: Clone Moodle
        run: |
          git clone --depth 1 --branch ${{ matrix.moodle_ref }} https://github.com/moodle/moodle.git /tmp/moodle

      - name: Configure Moodle
        run: |
          cd /tmp/moodle
          
          # Create data directory
          mkdir -p /tmp/moodledata
          chmod 777 /tmp/moodledata
          
          # Create config.php
          cat > config.php << 'EOF'
          <?php
          unset($CFG);
          global $CFG;
          $CFG = new stdClass();
          
          $CFG->dbtype    = 'pgsql';
          $CFG->dblibrary = 'native';
          $CFG->dbhost    = '127.0.0.1';
          $CFG->dbname    = 'moodle';
          $CFG->dbuser    = 'moodle';
          $CFG->dbpass    = 'moodle';
          $CFG->prefix    = 'mdl_';
          $CFG->dboptions = array(
              'dbpersist' => false,
              'dbsocket'  => false,
              'dbport'    => '5432',
          );
          
          $CFG->wwwroot   = 'http://localhost';
          $CFG->dataroot  = '/tmp/moodledata';
          $CFG->directorypermissions = 0777;
          $CFG->admin = 'admin';
          
          require_once(__DIR__ . '/lib/setup.php');
          EOF

      - name: Install Moodle
        run: |
          cd /tmp/moodle
          php admin/cli/install_database.php \
            --agree-license \
            --adminpass="Admin123!" \
            --adminemail="admin@example.com" \
            --fullname="Moodle Test" \
            --shortname="moodle"

      - name: Enable Web Services
        run: |
          cd /tmp/moodle
          php admin/cli/cfg.php --name=enablewebservices --set=1

      - name: Extract Schema
        run: |
          cp scripts/extract-ws.php /tmp/moodle/
          cd /tmp/moodle
          MOODLE_ROOT=/tmp/moodle php extract-ws.php > ${{ github.workspace }}/schemas/${{ matrix.moodle_ref }}.json

      - name: Upload Schema Artifact
        uses: actions/upload-artifact@v4
        with:
          name: schema-${{ matrix.moodle_ref }}
          path: schemas/${{ matrix.moodle_ref }}.json
          retention-days: 1

  generate-code:
    runs-on: ubuntu-latest
    needs: extract-schema

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Download All Schemas
        uses: actions/download-artifact@v4
        with:
          path: schemas
          pattern: schema-*
          merge-multiple: true

      - name: List Downloaded Schemas
        run: ls -la schemas/

      - name: Run Code Generation
        run: npm run codegen

      - name: Build Package
        run: npm run build

      - name: Type Check
        run: npm run typecheck

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          # To use GITHUB_TOKEN, enable in repo Settings > Actions > General > 
          # "Allow GitHub Actions to create and approve pull requests"
          # Alternatively, use a PAT with 'repo' scope stored as a secret
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update generated types for Moodle APIs"
          title: "chore: Update Moodle API Types"
          body: |
            This PR was automatically generated by the code generation workflow.
            
            ## Changes
            - Updated schema files from Moodle source
            - Regenerated TypeScript types and function wrappers
            
            ## Moodle Versions
            - MOODLE_405_STABLE
            - MOODLE_500_STABLE
            
            Please review the generated code before merging.
          branch: chore/update-moodle-types
          delete-branch: true
          labels: |
            automated
            codegen

      - name: Fallback - Commit directly if PR creation fails
        if: failure()
        run: |
          echo "::warning::Could not create PR. Enable 'Allow GitHub Actions to create and approve pull requests' in repository Settings > Actions > General"
          echo "Changes have been built but not committed. Run workflow manually or enable PR creation."
